# The lifecycle of `kubectl get all`

## A quick overview

```bash
$kubectl -v=6 get all
I0612 22:23:02.481509   63898 loader.go:372] Config loaded from file:  /Users/park/.kube/config
I0612 22:23:02.505277   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/api/v1/namespaces/default/pods?limit=500 200 OK in 14 milliseconds
I0612 22:23:02.508702   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/api/v1/namespaces/default/replicationcontrollers?limit=500 200 OK in 3 milliseconds
I0612 22:23:02.511794   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/api/v1/namespaces/default/services?limit=500 200 OK in 3 milliseconds
I0612 22:23:02.515644   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/apps/v1/namespaces/default/daemonsets?limit=500 200 OK in 3 milliseconds
I0612 22:23:02.518787   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/apps/v1/namespaces/default/deployments?limit=500 200 OK in 3 milliseconds
I0612 22:23:02.521967   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/apps/v1/namespaces/default/replicasets?limit=500 200 OK in 3 milliseconds
I0612 22:23:02.524796   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/apps/v1/namespaces/default/statefulsets?limit=500 200 OK in 2 milliseconds
I0612 22:23:02.527421   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/autoscaling/v1/namespaces/default/horizontalpodautoscalers?limit=500 200 OK in 2 milliseconds
I0612 22:23:02.529131   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/batch/v1/namespaces/default/cronjobs?limit=500 200 OK in 1 milliseconds
I0612 22:23:02.530539   63898 round_trippers.go:454] GET https://kubernetes.docker.internal:6443/apis/batch/v1/namespaces/default/jobs?limit=500 200 OK in 1 milliseconds
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   22h
```

kubectl has the follow steps:

1. load configuration to discovery cluster, authenticate as the identity defined in the config file
2. expand `all` to the real kubernetes resources like pod, replicationcontroller, service, daemonset, deployment, ...
3. request each resources from the cluster server
4. print out the response resource objects

Let's walk through the above 4 steps in details, note that we will not touch the
internals of cluster server, we only care the kubectl client specific details.

## `./kube/config`

```bash
$kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://kubernetes.docker.internal:6443
  name: docker-desktop
contexts:
- context:
    cluster: docker-desktop
    user: docker-desktop
  name: docker-desktop
current-context: docker-desktop
kind: Config
preferences: {}
users:
- name: docker-desktop
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED
```

There is a default `context` which organize `user` and `cluster`. So `kubectl`
will speaks to `cluster docker-desktop`, authenticates as `user docker-desktop`.

For our case, cluster is a server and user is authenticated by its client
certificate.

## expand all to kubernetes resources

We all know that there is no such `all` kubernetes resource, `all` is here to
stand for a collection of kubernetes resources.

I dumped the kubectl call stack, `all` will be expanded to specific kubernetes
resources.

```text
 0  0x00000001056fda98 in k8s.io/client-go/restmapper.discoveryCategoryExpander.Expand
    at ./vendor/k8s.io/client-go/restmapper/category_expansion.go:76
 1  0x00000001057034f8 in k8s.io/client-go/restmapper.(*discoveryCategoryExpander).Expand
    at <autogenerated>:1
 2  0x000000010587a218 in k8s.io/cli-runtime/pkg/resource.(*Builder).ReplaceAliases
    at ./vendor/k8s.io/cli-runtime/pkg/resource/builder.go:609
 3  0x0000000105879910 in k8s.io/cli-runtime/pkg/resource.(*Builder).ResourceTypeOrNameArgs
    at ./vendor/k8s.io/cli-runtime/pkg/resource/builder.go:573
 4  0x0000000105da2c30 in k8s.io/kubectl/pkg/cmd/get.(*GetOptions).Run
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:474
 5  0x0000000105dae310 in k8s.io/kubectl/pkg/cmd/get.NewCmdGet.func1
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:167
 6  0x00000001048b3b08 in github.com/spf13/cobra.(*Command).execute
    at ./vendor/github.com/spf13/cobra/command.go:854
 7  0x00000001048b4380 in github.com/spf13/cobra.(*Command).ExecuteC
    at ./vendor/github.com/spf13/cobra/command.go:958
 8  0x00000001048b3df0 in github.com/spf13/cobra.(*Command).Execute
    at ./vendor/github.com/spf13/cobra/command.go:895
 9  0x0000000105eb5670 in main.main
    at ./cmd/kubectl/kubectl.go:49
10  0x00000001045b1d34 in runtime.main
    at /usr/local/go/src/runtime/proc.go:225
11  0x00000001045e7964 in runtime.goexit
    at /usr/local/go/src/runtime/asm_arm64.s:1130
```

The following live debug print shows `Categories` is a field of `type
APIResource`.

```text
k8s.io/apimachinery/pkg/apis/meta/v1.APIResource {
	Name: "pods",
	SingularName: "",
	Namespaced: true,
	Group: "",
	Version: "",
	Kind: "Pod",
	Verbs: k8s.io/apimachinery/pkg/apis/meta/v1.Verbs len: 8, cap: 8, [
		"create",
		"delete",
		"deletecollection",
		"get",
		"list",
		"patch",
		"update",
		"watch",
	],
	ShortNames: []string len: 1, cap: 1, ["po"],
	Categories: []string len: 1, cap: 1, ["all"],
	StorageVersionHash: "xPOwRZ+Yhw8=",}
```

## kubectl get service/kubernetes

- kubectl will make a request to the cluster server:

```text
 0  0x000000010606c25c in k8s.io/client-go/transport.(*debuggingRoundTripper).RoundTrip
    at ./vendor/k8s.io/client-go/transport/round_trippers.go:468
 1  0x00000001060697f4 in k8s.io/client-go/transport.(*userAgentRoundTripper).RoundTrip
    at ./vendor/k8s.io/client-go/transport/round_trippers.go:160
 2  0x00000001053609d8 in net/http.send
    at /usr/local/go/src/net/http/client.go:251
 3  0x00000001053603d8 in net/http.(*Client).send
    at /usr/local/go/src/net/http/client.go:175
 4  0x0000000105363358 in net/http.(*Client).do
    at /usr/local/go/src/net/http/client.go:717
 5  0x0000000105362650 in net/http.(*Client).Do
    at /usr/local/go/src/net/http/client.go:585
 6  0x0000000106096020 in k8s.io/client-go/rest.(*Request).request
    at ./vendor/k8s.io/client-go/rest/request.go:980
 7  0x00000001060962dc in k8s.io/client-go/rest.(*Request).Do
    at ./vendor/k8s.io/client-go/rest/request.go:1038
 8  0x000000010622a598 in k8s.io/cli-runtime/pkg/resource.(*Helper).Get
    at ./vendor/k8s.io/cli-runtime/pkg/resource/helper.go:85
 9  0x0000000106232240 in k8s.io/cli-runtime/pkg/resource.(*Info).Get
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:96
10  0x0000000106236298 in k8s.io/cli-runtime/pkg/resource.RetrieveLazy
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:669
11  0x00000001062376a8 in k8s.io/cli-runtime/pkg/resource.DecoratedVisitor.Visit.func1
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:327
12  0x000000010623786c in k8s.io/cli-runtime/pkg/resource.ContinueOnErrorVisitor.Visit.func1
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:355
13  0x00000001062383fc in k8s.io/cli-runtime/pkg/resource.FlattenListVisitor.Visit.func1
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:392
14  0x00000001062374dc in k8s.io/cli-runtime/pkg/resource.EagerVisitorList.Visit.func1
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:214
15  0x0000000106232138 in k8s.io/cli-runtime/pkg/resource.(*Info).Visit
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:91
16  0x0000000106233a68 in k8s.io/cli-runtime/pkg/resource.EagerVisitorList.Visit
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:209
17  0x000000010623aa2c in k8s.io/cli-runtime/pkg/resource.(*EagerVisitorList).Visit
    at <autogenerated>:1
18  0x0000000106234b94 in k8s.io/cli-runtime/pkg/resource.FlattenListVisitor.Visit
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:387
19  0x000000010623a64c in k8s.io/cli-runtime/pkg/resource.(*FlattenListVisitor).Visit
    at <autogenerated>:1
20  0x000000010623484c in k8s.io/cli-runtime/pkg/resource.ContinueOnErrorVisitor.Visit
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:350
21  0x0000000106239f10 in k8s.io/cli-runtime/pkg/resource.(*ContinueOnErrorVisitor).Visit
    at <autogenerated>:1
22  0x00000001062346d4 in k8s.io/cli-runtime/pkg/resource.DecoratedVisitor.Visit
    at ./vendor/k8s.io/cli-runtime/pkg/resource/visitor.go:322
23  0x000000010623a44c in k8s.io/cli-runtime/pkg/resource.(*DecoratedVisitor).Visit
    at <autogenerated>:1
24  0x000000010622ff7c in k8s.io/cli-runtime/pkg/resource.(*Result).Infos
    at ./vendor/k8s.io/cli-runtime/pkg/resource/result.go:122
25  0x000000010674ae44 in k8s.io/kubectl/pkg/cmd/get.(*GetOptions).Run
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:494
26  0x0000000106756310 in k8s.io/kubectl/pkg/cmd/get.NewCmdGet.func1
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:167
27  0x000000010525bb08 in github.com/spf13/cobra.(*Command).execute
    at ./vendor/github.com/spf13/cobra/command.go:854
28  0x000000010525c380 in github.com/spf13/cobra.(*Command).ExecuteC
    at ./vendor/github.com/spf13/cobra/command.go:958
29  0x000000010525bdf0 in github.com/spf13/cobra.(*Command).Execute
    at ./vendor/github.com/spf13/cobra/command.go:895
30  0x000000010685d670 in main.main
    at ./cmd/kubectl/kubectl.go:49
31  0x0000000104f59d34 in runtime.main
    at /usr/local/go/src/runtime/proc.go:225
32  0x0000000104f8f964 in runtime.goexit
    at /usr/local/go/src/runtime/asm_arm64.s:1130
```

- kubectl request object dump:

```text
*k8s.io/client-go/transport.requestInfo {
	RequestHeaders: net/http.Header [
		"Accept": [
			"application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json",
		],
		"User-Agent": [
			"__debug_bin/v0.0.0 (darwin/arm64) kubernetes/$Format",
		],
	],
	RequestVerb: "GET",
	RequestURL: "https://kubernetes.docker.internal:6443/api/v1/namespaces/default/services/kubernetes",
	ResponseStatus: "200 OK",
	ResponseHeaders: net/http.Header [
		"Cache-Control": [
			"no-cache, private",
		],
		"Content-Type": [
			"application/json",
		],
		"X-Kubernetes-Pf-Flowschema-Uid": [
			"52e312ef-2e2b-4aaa-8d84-2811a85296ea",
		],
		"X-Kubernetes-Pf-Prioritylevel-Uid": [
			"7d2e8485-f393-44e2-b869-1bc434c5dc80",
		],
		"Date": [
			"Sun, 13 Jun 2021 04:25:16 GMT",
		],
	],
	ResponseErr: error nil,
	Duration: 2861656875,}
```

- cluster server response dump:

```text
k8s.io/apimachinery/pkg/runtime.Object(*k8s.io/apimachinery/pkg/apis/meta/v1/unstructured.Unstructured) *{
	Object: map[string]interface {} [
		"kind": *(*interface {})(0x140002e61a8),
		"apiVersion": *(*interface {})(0x140002e61b8),
		"metadata": *(*interface {})(0x140002e61c8),
		"columnDefinitions": *(*interface {})(0x140002e61d8),
		"rows": *(*interface {})(0x140002e61e8),
	],}
```

## print service objects

- print will be delegated to kubectl get command printer:

```text
 0  0x000000010157bc10 in k8s.io/cli-runtime/pkg/printers.printTable
    at ./vendor/k8s.io/cli-runtime/pkg/printers/tableprinter.go:191
 1  0x000000010157b22c in k8s.io/cli-runtime/pkg/printers.(*HumanReadablePrinter).PrintObj
    at ./vendor/k8s.io/cli-runtime/pkg/printers/tableprinter.go:143
 2  0x000000010158224c in k8s.io/cli-runtime/pkg/printers.(*TypeSetterPrinter).PrintObj
    at ./vendor/k8s.io/cli-runtime/pkg/printers/typesetter.go:46
 3  0x0000000101a41c04 in k8s.io/kubectl/pkg/cmd/get.(*TablePrinter).PrintObj
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/table_printer.go:41
 4  0x0000000101970fd8 in k8s.io/cli-runtime/pkg/printers.ResourcePrinter.PrintObj-fm
    at ./vendor/k8s.io/cli-runtime/pkg/printers/interface.go:37
 5  0x000000010157709c in k8s.io/cli-runtime/pkg/printers.ResourcePrinterFunc.PrintObj
    at ./vendor/k8s.io/cli-runtime/pkg/printers/interface.go:31
 6  0x0000000101a37808 in k8s.io/kubectl/pkg/cmd/get.(*GetOptions).Run
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:579
 7  0x0000000101a42310 in k8s.io/kubectl/pkg/cmd/get.NewCmdGet.func1
    at ./vendor/k8s.io/kubectl/pkg/cmd/get/get.go:167
 8  0x0000000100547b08 in github.com/spf13/cobra.(*Command).execute
    at ./vendor/github.com/spf13/cobra/command.go:854
 9  0x0000000100548380 in github.com/spf13/cobra.(*Command).ExecuteC
    at ./vendor/github.com/spf13/cobra/command.go:958
10  0x0000000100547df0 in github.com/spf13/cobra.(*Command).Execute
    at ./vendor/github.com/spf13/cobra/command.go:895
11  0x0000000101b49670 in main.main
    at ./cmd/kubectl/kubectl.go:49
12  0x0000000100245d34 in runtime.main
    at /usr/local/go/src/runtime/proc.go:225
13  0x000000010027b964 in runtime.goexit
    at /usr/local/go/src/runtime/asm_arm64.s:1130
```
